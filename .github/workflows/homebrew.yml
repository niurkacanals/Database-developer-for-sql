name: Bump Homebrew Formula
on:
  push:
    tags: 'v*'
jobs:
  homebrew:
    runs-on: macos-latest
    steps:
      - name: checkout
        uses: actions/checkout@v3
      - name: bump formula
        env:
          HOMEBREW_GITHUB_API_TOKEN: ${{ secrets.HOMEBREW_TOKEN }}
        run: |
          export REPO_PATH=$(brew --prefix)/Homebrew/Library/Taps/xo/homebrew-xo
          brew update
          brew tap xo/xo
          git -C $REPO_PATH config user.name 'Kenneth Shaw'
          git -C $REPO_PATH config user.email 'ken@usql.app'
          git -C $REPO_PATH remote set-url origin 'https://kenshaw:${{ secrets.HOMEBREW_TOKEN }}@github.com/xo/homebrew-xo.git'
          brew bump-formula-pr \
            --no-audit \
            --no-browse \
            --write-only \
            --commit \
            --no-fork \
            --force \
            --message='Update usql formula to ${{ github.ref_name }}' \
            --url='https://github.com/xo/usql/archive/${{ github.ref_name }}.tar.gz' \
            xo/xo/usql
          git -C $REPO_PATH show -C
          git -C $REPO_PATH push origin master
